import { useState } from "react";
import { ethers } from "ethers";
import Web3Modal from "web3modal";

// عنوان العقد الذكي
const CONTRACT_ADDRESS = "0x33c847a9954f5FcB8a5cf32Bbbc3dDD56Bb80730";

// ABI كامل (اللي عطيتيني)
const ABI = [ 
  // فقط حطيت أهم الميثودز، تقدر تزيد كاملين
  {
    "inputs": [],
    "name": "totalUsers",
    "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalCommissions",
    "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{ "internalType": "address", "name": "", "type": "address" }],
    "name": "users",
    "outputs": [
      { "internalType": "address", "name": "referrer", "type": "address" },
      { "internalType": "uint256", "name": "directReferrals", "type": "uint256" },
      { "internalType": "uint256", "name": "totalEarned", "type": "uint256" },
      { "internalType": "uint8", "name": "maxLevel", "type": "uint8" }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

export default function JerryDashboard() {
  const [account, setAccount] = useState("");
  const [totalUsers, setTotalUsers] = useState(0n);
  const [totalCommissions, setTotalCommissions] = useState(0n);
  const [userInfo, setUserInfo] = useState(null);

  async function connectWallet() {
    try {
      const web3Modal = new Web3Modal();
      const connection = await web3Modal.connect();
      const provider = new ethers.BrowserProvider(connection);
      const signer = await provider.getSigner();
      const address = await signer.getAddress();
      setAccount(address);

      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

      // نجيبو المعلومات من العقد
      const users = await contract.totalUsers();
      const commissions = await contract.totalCommissions();
      const user = await contract.users(address);

      setTotalUsers(users);
      setTotalCommissions(commissions);
      setUserInfo(user);

    } catch (err) {
      console.error("Connection failed:", err);
    }
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center">
      <h1 className="text-2xl font-bold mb-6">Jerry dApp Dashboard</h1>

      {!account ? (
        <button
          onClick={connectWallet}
          className="px-6 py-3 bg-blue-600 text-white rounded-xl"
        >
          Connect Wallet
        </button>
      ) : (
        <div className="bg-white shadow-lg rounded-xl p-6 w-96 text-left space-y-3">
          <p><b>Wallet:</b> {account}</p>
          <p><b>Total Users:</b> {totalUsers.toString()}</p>
          <p><b>Total Commissions:</b> {ethers.formatEther(totalCommissions)} ETH</p>

          {userInfo && (
            <div className="mt-4">
              <h2 className="font-bold">My Info:</h2>
              <p>Referrer: {userInfo.referrer}</p>
              <p>Direct Referrals: {userInfo.directReferrals.toString()}</p>
              <p>Total Earned: {ethers.formatEther(userInfo.totalEarned)} ETH</p>
              <p>Max Level: {userInfo.maxLevel}</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
