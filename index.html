<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jerry Smart Matrix - Ultimate Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.css" rel="stylesheet" />
<style>
body { font-family: 'Arial', sans-serif; background: #f9f9f9; padding: 20px; margin: 0;}
h1, h2 { color: #222; text-align: center; }
.card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.1);}
button { padding: 10px 20px; margin-top: 10px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;}
button:hover { background: #45a049; }
input { padding: 8px; width: 250px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc;}
#network { height: 600px; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
#search { width: 200px; margin-bottom: 10px; padding: 6px;}
.stats-grid { display: flex; flex-wrap: wrap; justify-content: space-around; margin-top: 10px;}
.stats-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 5px; flex: 1 1 150px; text-align: center; }
</style>
</head>
<body>

<h1>Jerry Smart Matrix - Ultimate Dashboard</h1>

<!-- زر اتصال MetaMask -->
<div style="text-align:center; margin-bottom: 20px;">
    <button onclick="connectMetaMask()">Connect MetaMask</button>
</div>

<div class="card">
    <h2>General Stats</h2>
    <div class="stats-grid">
        <div class="stats-box">Total Users: <span id="totalUsers">0</span></div>
        <div class="stats-box">Total Commissions: <span id="totalCommissions">0</span> JRY</div>
    </div>
    <button onclick="updateStats()">Refresh Stats</button>
</div>

<div class="card">
    <h2>Member Dashboard</h2>
    <div class="stats-grid">
        <div class="stats-box">Your Level: <span id="myLevel">0</span></div>
        <div class="stats-box">Your Earnings: <span id="myEarnings">0</span> JRY</div>
        <div class="stats-box">Direct Referrals: <span id="myDirects">0</span></div>
        <div class="stats-box">Team Size: <span id="myTeamSize">0</span></div>
    </div>
</div>

<div class="card">
    <h2>Buy Level</h2>
    <label>Level (0-9):</label><br>
    <input type="number" id="level" min="0" max="9" value="0"><br>
    <label>Referrer Address:</label><br>
    <input type="text" id="referrer" placeholder="0x..."><br>
    <button onclick="buyLevel()">Buy Level</button>
</div>

<div class="card">
    <h2>Search Member</h2>
    <input type="text" id="search" placeholder="Enter address...">
    <button onclick="searchMember()">Search</button>
</div>

<div class="card">
    <h2>Your Team Tree</h2>
    <div id="network"></div>
</div>

<script>
const contractAddress = "0x33c847a9954f5FcB8a5cf32Bbbc3dDD56Bb80730";
const abi = [
    "function totalUsers() view returns (uint256)",
    "function totalCommissions() view returns (uint256)",
    "function users(address) view returns (address referrer, uint256 directReferrals, uint256 totalEarned, uint8 maxLevel, address[] team)",
    "function buyLevel(uint8 _level, address _referrer)",
    "function _findAvailableReferrer(address _ref) view returns(address)"
];

let provider, signer, contract, networkInstance, nodesDS, edgesDS;

async function connectMetaMask() {
    if(window.ethereum){
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, abi, signer);
        updateStats();
        drawMemberDashboard();
        drawTeamTree();
        setInterval(updateStats, 10000);
        setInterval(drawMemberDashboard, 10000);
        setInterval(drawTeamTree, 10000);
    } else {
        alert("Please install MetaMask!");
    }
}

async function updateStats(){
    const totalUsers = await contract.totalUsers();
    const totalCommissions = await contract.totalCommissions();
    document.getElementById("totalUsers").innerText = totalUsers.toString();
    document.getElementById("totalCommissions").innerText = ethers.utils.formatUnits(totalCommissions, 18);
}

async function drawMemberDashboard(){
    const userAddress = await signer.getAddress();
    const userData = await contract.users(userAddress);
    document.getElementById("myLevel").innerText = userData.maxLevel;
    document.getElementById("myEarnings").innerText = ethers.utils.formatUnits(userData.totalEarned,18);
    document.getElementById("myDirects").innerText = userData.directReferrals;
    document.getElementById("myTeamSize").innerText = userData.team.length;
}

async function buyLevel(){
    const level = parseInt(document.getElementById("level").value);
    const referrer = document.getElementById("referrer").value;
    try{
        const tx = await contract.buyLevel(level, referrer);
        await tx.wait();
        alert("Level purchased successfully!");
        updateStats();
        drawMemberDashboard();
        drawTeamTree();
    } catch(err){
        console.error(err);
        alert("Transaction failed: " + err.message);
    }
}

async function drawTeamTree(){
    const userAddress = await signer.getAddress();
    const nodes = [{id: userAddress, label: "You\nLvl: 0\nEarned: 0", color: "#4CAF50"}];
    const edges = [];

    async function addTeamRecursive(address, parentId){
        const userData = await contract.users(address);
        if(userData.team){
            for(let i=0;i<userData.team.length;i++){
                const child = userData.team[i];
                const childData = await contract.users(child);
                const color = childData.referrer.toLowerCase() === parentId.toLowerCase() ? "#87CEFA" : "#FFD700";
                nodes.push({
                    id: child,
                    label: child.substring(0,6)+"...\nLvl:"+childData.maxLevel+"\nEarned:"+ethers.utils.formatUnits(childData.totalEarned,18),
                    color: color,
                    title: `Address: ${child}\nLevel: ${childData.maxLevel}\nEarned: ${ethers.utils.formatUnits(childData.totalEarned,18)} JRY\nDirect: ${childData.directReferrals}`
                });
                edges.push({from: parentId, to: child});
                await addTeamRecursive(child, child);
            }
        }
    }

    await addTeamRecursive(userAddress, userAddress);

    const container = document.getElementById("network");
    const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
    const options = {
        nodes: { shape: "box", font: {multi: "html"} },
        edges: { arrows: "to" },
        layout: { hierarchical: { direction: "UD", sortMethod: "directed" } },
        physics: { enabled: false },
        interaction: { hover: true, navigationButtons: true, keyboard: true }
    };
    if(!networkInstance){
        networkInstance = new vis.Network(container, data, options);
        nodesDS = data.nodes;
        edgesDS = data.edges;
    } else {
        nodesDS.clear();
        edgesDS.clear();
        nodesDS.add(nodes);
        edgesDS.add(edges);
    }
}

async function searchMember(){
    const searchAddr = document.getElementById("search").value.trim();
    if(!searchAddr) return;
    const userData = await contract.users(searchAddr);
    alert(`User: ${searchAddr}\nLevel: ${
