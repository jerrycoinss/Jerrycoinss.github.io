<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jerry Token Sale - DApp</title>

  <!-- ethers v6 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f3f4f6; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { width: 360px; background:#fff; border-radius:16px; padding:20px; box-shadow: 0 8px 30px rgba(2,6,23,0.08); }
    h1{ font-size:20px; margin:0 0 12px; text-align:center; }
    .muted{ color:#6b7280; font-size:13px; }
    .row{ margin:10px 0; }
    input[type="number"]{ width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; font-size:15px; }
    button{ width:100%; padding:10px; border-radius:10px; border:0; font-weight:600; cursor:pointer; }
    .btn-connect{ background:#2563eb; color:white; }
    .btn-buy{ background:#16a34a; color:white; }
    .small{ font-size:13px; color:#374151; }
    .error{ color:#b91c1c; font-size:13px; margin-top:8px; }
    .success{ color:#059669; font-size:13px; margin-top:8px; }
    .info{ color:#0f172a; font-size:13px; margin-top:8px; }
    .flex-between{ display:flex; justify-content:space-between; align-items:center; }
    .address{ font-size:12px; color:#111827; word-break:break-all; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Jerry Token Sale</h1>
    <p class="muted" style="text-align:center">Buy <strong>JRY</strong> with <strong>USDT</strong> — Fixed rate: <strong>1 USDT = 20,000 JRY</strong></p>

    <div id="notInstalled" style="display:none" class="row error">MetaMask / Web3 provider not found. نصب MetaMask أو محفظة تدعم EIP-1193.</div>

    <div id="preConnect" class="row">
      <button id="connectBtn" class="btn-connect">Connect Wallet</button>
      <p class="muted" style="text-align:center;margin-top:8px">Network: BNB Smart Chain (recommended)</p>
    </div>

    <div id="afterConnect" style="display:none">
      <div class="row flex-between">
        <div>
          <div class="small">Connected</div>
          <div id="account" class="address"></div>
        </div>
        <div style="text-align:right">
          <div class="small">Remaining JRY</div>
          <div id="remaining" class="address">--</div>
        </div>
      </div>

      <div class="row">
        <input id="usdtAmount" type="number" min="0" step="any" placeholder="Enter USDT amount (e.g. 1.5)" />
      </div>

      <div class="row flex-between">
        <div class="small">You will get</div>
        <div id="jryAmount" class="small"><strong>0 JRY</strong></div>
      </div>

      <div class="row">
        <button id="approveBtn" style="display:none" class="btn-connect">Approve USDT (if needed)</button>
        <button id="buyBtn" class="btn-buy">Buy JRY</button>
      </div>

      <div id="status" class="info" style="display:none"></div>
      <div id="err" class="error" style="display:none"></div>
      <div id="ok" class="success" style="display:none"></div>
    </div>
  </div>

  <script>
    (function(){
      // ====== CONFIG ======
      const CONTRACT_ADDRESS = "0x8e8cF4ac64e1C39A96A70C5900583FA402Cb6Be2";
      const RATE = 20000; // 1 USDT = 20,000 JRY
      const JRY_DECIMALS = 18;
      const USDT_DECIMALS = 18;

      // ABI minimal
      const CONTRACT_ABI = [
        "function buy(uint256 usdtAmount) external",
        "function remaining() view returns (uint256)",
        "event Bought(address indexed buyer, uint256 usdtIn, uint256 jryOut)"
      ];

      // Elements
      const connectBtn = document.getElementById("connectBtn");
      const preConnect = document.getElementById("preConnect");
      const afterConnect = document.getElementById("afterConnect");
      const notInstalled = document.getElementById("notInstalled");
      const accountEl = document.getElementById("account");
      const remainingEl = document.getElementById("remaining");
      const usdtInput = document.getElementById("usdtAmount");
      const jryAmountEl = document.getElementById("jryAmount");
      const buyBtn = document.getElementById("buyBtn");
      const statusEl = document.getElementById("status");
      const errEl = document.getElementById("err");
      const okEl = document.getElementById("ok");

      // web3
      let provider, signer, account, contract;

      function showError(msg){
        errEl.style.display = "block"; errEl.innerText = msg;
        okEl.style.display = "none";
        statusEl.style.display = "none";
      }
      function showStatus(msg){
        statusEl.style.display = "block"; statusEl.innerText = msg;
        errEl.style.display = "none";
        okEl.style.display = "none";
      }
      function showOk(msg){
        okEl.style.display = "block"; okEl.innerText = msg;
        statusEl.style.display = "none";
        errEl.style.display = "none";
      }

      // detect provider
      if (!window.ethereum) {
        notInstalled.style.display = "block";
        preConnect.style.display = "none";
      }

      connectBtn.addEventListener("click", async () => {
        try {
          if (!window.ethereum) { notInstalled.style.display = "block"; return; }
          // request accounts
          provider = new ethers.BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
          account = await signer.getAddress();
          accountEl.innerText = account;

          // init contract
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          preConnect.style.display = "none";
          afterConnect.style.display = "block";

          // fetch remaining
          await fetchRemaining();
          listenEvents();
          showStatus("Wallet connected.");
        } catch (e) {
          console.error(e);
          showError("فشل الاتصال بالمحفظة. شوف الكونسول للمزيد.");
        }
      });

      usdtInput.addEventListener("input", () => {
        const v = parseFloat(usdtInput.value);
        if (!v || v <= 0) {
          jryAmountEl.innerHTML = "<strong>0 JRY</strong>";
          return;
        }
        const jry = (v * RATE);
        jryAmountEl.innerHTML = "<strong>" + Number(jry).toLocaleString() + " JRY</strong>";
      });

      buyBtn.addEventListener("click", async () => {
        errEl.style.display = "none"; okEl.style.display = "none";
        const v = parseFloat(usdtInput.value);
        if (!v || v <= 0) return showError("دخل قيمة USDT صحيحة.");
        if (!contract) return showError("العقد مازال ما تربطش.");

        try {
          showStatus("تحضير المعاملة... تأكد من محفظتك.");
          const amount = ethers.parseUnits(v.toString(), USDT_DECIMALS); // requires ethers v6

          // call buy
          const tx = await contract.buy(amount);
          showStatus("معاملة مرسلة... تنتظر التأكيد (1/2) TxHash: " + tx.hash);
          await tx.wait();
          showOk("شراء تم بنجاح ✅");
          await fetchRemaining();
        } catch (e) {
          console.error(e);
          const msg = (e && e.message) ? e.message : "Transaction failed";
          showError("فشل المعاملة: " + msg);
        }
      });

      async function fetchRemaining(){
        try {
          if (!contract) return;
          const rem = await contract.remaining();
          // rem is BigInt or ethers BigNumber-like; format with ethers.formatUnits
          const human = ethers.formatUnits(rem, JRY_DECIMALS);
          remainingEl.innerText = Number(human).toLocaleString();
        } catch (e) {
          console.error(e);
          remainingEl.innerText = "--";
        }
      }

      function listenEvents(){
        try {
          if (!contract) return;
          // Listen to Bought events to update UI in real-time
          contract.on("Bought", (buyer, usdtIn, jryOut) => {
            // only show when relevant or update remaining
            fetchRemaining();
            // optional: notify if current user bought
            if (buyer && account && buyer.toLowerCase() === account.toLowerCase()) {
              showOk("تم شراء JRY! المبلغ: " + ethers.formatUnits(jryOut, JRY_DECIMALS) + " JRY");
            }
          });
        } catch (e) {
          console.error("listenEvents error", e);
        }
      }

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        try {
          if (contract && contract.off) contract.removeAllListeners("Bought");
        } catch {}
      });

    })();
  </script>
</body>
</html>
