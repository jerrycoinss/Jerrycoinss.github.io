<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jerry Smart Matrix - DApp (Auto-Approve)</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.css" rel="stylesheet" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#071224;color:#fff;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  h1{ text-align:center }
  .card{background:#071b2a;padding:14px;border-radius:10px;margin:12px 0}
  button{padding:10px 14px;border-radius:8px;border:0;background:#0ab;cursor:pointer;color:#002}
  button.secondary{background:#33a;}
  input{padding:8px;border-radius:8px;border:1px solid #123;background:#05101a;color:#fff;width:100%}
  .levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}
  .level-card{background:#042032;padding:10px;border-radius:8px}
  #network{height:380px;background:#fff;border-radius:8px;margin-top:10px}
  .muted{color:#9fb0c4}
</style>
</head>
<body>
<div class="wrap">
  <h1>Jerry Smart Matrix â€” DApp</h1>

  <div class="card">
    <div style="display:flex;gap:12px;align-items:center">
      <button id="btnConnect">Connect Wallet</button>
      <div>
        <div id="addr" class="muted">Not connected</div>
        <div id="net" class="muted"></div>
      </div>
      <div style="margin-left:auto">
        <button id="btnRefresh" class="secondary">Refresh</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="muted">Total Users: <strong id="totalUsers">-</strong></div>
      <div class="muted">Total Commissions: <strong id="totalCommissions">-</strong></div>
      <div class="muted">JRY Token: <strong id="tokenAddr">-</strong></div>
    </div>
  </div>

  <div class="card">
    <h3>Your Dashboard</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="muted">Level: <strong id="myLevel">-</strong></div>
      <div class="muted">Earnings: <strong id="myEarnings">-</strong></div>
      <div class="muted">Directs: <strong id="myDirects">-</strong></div>
      <div class="muted">Team: <strong id="myTeamSize">-</strong></div>
    </div>
  </div>

  <div class="card">
    <h3>Buy Levels (Auto-approve)</h3>
    <div id="levelsContainer" class="levels">Loading...</div>
  </div>

  <div class="card">
    <h3>Search Member</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="searchInput" placeholder="0x..." />
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchRes" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>Your Team Tree</h3>
    <div id="network"></div>
  </div>

  <div class="muted" style="text-align:center;margin-top:12px">
    Open inside MetaMask Mobile browser or desktop with MetaMask. Network: BSC mainnet.
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const MATRIX_ADDRESS = "0x33c847a9954f5FcB8a5cf32Bbbc3dDD56Bb80730"; // JerrySmartMatrix
const JRY_ADDRESS    = "0x2eb0d06Fad17a1Ba62D705873cF5E49778794134"; // Jerry token

const MATRIX_ABI = [
  {"inputs":[{"internalType":"address","name":"_jerryToken","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"DIRECT_RATE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MAX_DIRECTS","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"TOTAL_LEVELS","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"TREASURY_RATE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint8","name":"_level","type":"uint8"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"buyLevel","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"generationRates","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"jerryToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"levelPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"requiredDirects","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalCommissions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"directReferrals","type":"uint256"},{"internalType":"uint256","name":"totalEarned","type":"uint256"},{"internalType":"uint8","name":"maxLevel","type":"uint8"}],"stateMutability":"view","type":"function"}
];

const ERC20_ABI = [
  "function approve(address spender,uint256 amount) external returns (bool)",
  "function allowance(address owner,address spender) view returns (uint256)",
  "function balanceOf(address account) view returns (uint256)",
  "function decimals() view returns (uint8)"
];
/* --------------------------- */

let provider, signer, matrixContract, tokenContract, userAddress;
let networkInstance;

const $ = id => document.getElementById(id);

async function connect() {
  try {
    if(!window.ethereum) throw new Error("No Web3 wallet found");
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    $('addr').innerText = userAddress;
    const network = await provider.getNetwork();
    $('net').innerText = `${network.name} (chainId ${network.chainId})`;
    // init contracts (use signer so send transactions work)
    matrixContract = new ethers.Contract(MATRIX_ADDRESS, MATRIX_ABI, signer);
    tokenContract = new ethers.Contract(JRY_ADDRESS, ERC20_ABI, signer);
    $('tokenAddr').innerText = JRY_ADDRESS;
    await loadAll();
  } catch (e) {
    alert("Connect failed: " + (e.message||e));
    console.error(e);
  }
}

$('btnConnect').onclick = connect;
$('btnRefresh').onclick = async () => { if(matrixContract) await loadAll(); };

/* load everything */
async function loadAll(){
  await Promise.all([ loadGeneralStats(), loadUserDashboard(), loadLevels() ]);
  drawTeamTree();
}

/* general stats */
async function loadGeneralStats(){
  try{
    const [tu, tc] = await Promise.all([ matrixContract.totalUsers(), matrixContract.totalCommissions() ]);
    const dec = await safeDecimals();
    $('totalUsers').innerText = tu.toString();
    $('totalCommissions').innerText = ethers.utils.formatUnits(tc, dec);
  }catch(e){ console.error("loadGeneralStats",e); }
}

/* safe decimals */
async function safeDecimals(){
  try{ return await tokenContract.decimals(); } catch(e){ return 18; }
}

/* user dashboard */
async function loadUserDashboard(){
  try{
    if(!userAddress) return;
    const u = await matrixContract.users(userAddress);
    const dec = await safeDecimals();
    $('myLevel').innerText = u.maxLevel;
    $('myEarnings').innerText = ethers.utils.formatUnits(u.totalEarned, dec);
    $('myDirects').innerText = u.directReferrals.toString();
    $('myTeamSize').innerText = u.directReferrals.toString();
  }catch(e){ console.error("loadUserDashboard",e); }
}

/* load levels and add buy click handlers */
async function loadLevels(){
  try{
    const container = $('levelsContainer');
    container.innerHTML = '';
    const dec = await safeDecimals();
    const totalLevels = 10; // contract TOTAL_LEVELS =10
    for(let i=0;i<totalLevels;i++){
      const priceBase = await matrixContract.levelPrice(i); // price stored as integer (e.g., 5000)
      // contract uses price * 1e18 when transferring, so multiply by 1e18 to get token units
      const priceTokenUnits = priceBase.mul(ethers.constants.WeiPerEther); // priceBase * 1e18
      const priceHuman = ethers.utils.formatUnits(priceTokenUnits, dec);
      const card = document.createElement('div'); card.className='level-card';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">Level ${i}</div>
            <div class="muted">Price: ${priceHuman} JRY</div>
          </div>
          <div>
            <button class="buyBtn" data-level="${i}" data-price="${priceTokenUnits.toString()}">Buy</button>
          </div>
        </div>
      `;
      container.appendChild(card);
    }
    // attach handlers
    Array.from(document.getElementsByClassName('buyBtn')).forEach(btn => {
      btn.onclick = async (e) => {
        const level = parseInt(e.currentTarget.dataset.level);
        const priceStr = e.currentTarget.dataset.price;
        const ref = prompt("Referrer address (or leave empty):", "");
        const refAddr = (ref && ref.trim().length>0) ? ref.trim() : ethers.constants.AddressZero;
        await buyWithAutoApprove(level, ethers.BigNumber.from(priceStr), refAddr);
      };
    });
  }catch(e){ console.error("loadLevels",e); $('levelsContainer').innerText='Failed to load'; }
}

/* buy flow with auto-approve */
async function buyWithAutoApprove(level, priceTokenUnits, referrer){
  try{
    if(!matrixContract || !tokenContract) throw new Error("Connect first");
    // check user balance
    const bal = await tokenContract.balanceOf(userAddress);
    const dec = await safeDecimals();
    if(bal.lt(priceTokenUnits)) {
      alert(`Insufficient JRY balance. You have ${ethers.utils.formatUnits(bal,dec)} JRY`);
      return;
    }
    // check allowance
    let allowance = await tokenContract.allowance(userAddress, MATRIX_ADDRESS);
    if(ethers.BigNumber.from(allowance).lt(priceTokenUnits)){
      // request approval
      showNotice("Requesting token approval â€” confirm in wallet");
      const approveTx = await tokenContract.approve(MATRIX_ADDRESS, priceTokenUnits);
      await approveTx.wait();
      showNotice("Approval confirmed");
    }
    showNotice("Sending buyLevel tx â€” confirm in wallet");
    const tx = await matrixContract.buyLevel(level, referrer);
    await tx.wait();
    showNotice("Level purchased âœ“", 3000);
    await loadAll();
  } catch(e){
    console.error("buyWithAutoApprove", e);
    alert("Transaction failed: " + (e.message || e));
    showNotice("",0);
  }
}

/* simple notice area */
function showNotice(txt, timeout=0){
  let el = document.getElementById('net');
  if(!txt){ el.innerText = ''; return; }
  el.innerText = txt;
  if(timeout>0) setTimeout(()=> el.innerText = '', timeout);
}

/* search */
$('searchBtn').onclick = async ()=>{
  const addr = $('searchInput').value.trim();
  if(!addr) return alert("Enter address");
  try{
    const u = await matrixContract.users(addr);
    const dec = await safeDecimals();
    $('searchRes').innerText = `Ref: ${u.referrer} | Lvl:${u.maxLevel} | Earned:${ethers.utils.formatUnits(u.totalEarned,dec)} | Directs:${u.directReferrals}`;
  }catch(e){ console.error(e); alert("Not found / error"); }
};

/* team tree (best-effort using directReferrals only) */
async function drawTeamTree(){
  try{
    if(!matrixContract || !userAddress) return;
    const nodes = [], edges = [];
    nodes.push({id:userAddress, label: short(userAddress) + "\nYou", color:"#4CAF50"});
    // We cannot read stored address[] team from ABI (not exposed). We'll show numbered direct placeholders.
    const me = await matrixContract.users(userAddress);
    const directs = parseInt(me.directReferrals.toString() || "0");
    for(let i=0;i<directs;i++){
      const id = userAddress + "_d_"+i;
      nodes.push({id:id, label:"Direct #"+(i+1), color:"#87CEFA"});
      edges.push({from:userAddress, to:id});
    }
    const container = $('network');
    const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
    const options = { nodes:{shape:"box"}, layout:{hierarchical:{direction:"UD"}}, physics:{enabled:false} };
    if(!networkInstance) networkInstance = new vis.Network(container, data, options);
    else networkInstance.setData(data);
  }catch(e){ console.error("drawTeamTree",e); $('network').innerText='Unable to load tree'; }
}

function short(a){ return a.slice(0,6) + "..." + a.slice(-4); }

/* auto-connect if account present */
(async ()=>{
  if(window.ethereum){
    try{
      const tmpProv = new ethers.providers.Web3Provider(window.ethereum);
      const accs = await tmpProv.listAccounts();
      if(accs && accs.length>0) {
        // auto-connect
        await connect();
      }
    }catch(e){}
  }
})();
</script>
</body>
</html>
