<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jerry Smart Matrix DApp</title>
</head>
<body>
<h2>Jerry Smart Matrix</h2>
<button id="connectBtn">ğŸ”— Connect Wallet</button>

<div>
  <p id="account">Ø§Ù„Ø­Ø³Ø§Ø¨: ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·</p>
  <p id="bnbBalance">BNB: --</p>
  <p id="jryBalance">JRY: --</p>
  <p id="referrals">Direct Referrals: --</p>
  <p id="levels">Levels Purchased: --</p>
</div>

<div id="levelsPanel"></div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script>
const contractAddress = "0xB963CA4f5d123a1622f6D6ABd80c4bef85c90D12"; // Ø¹Ù‚Ø¯Ùƒ
const contractABI = [ /* Ù‡Ù†Ø§ ØªØ­Ø· ABI Ø¯ÙŠØ§Ù„ Ø§Ù„Ø¹Ù‚Ø¯ */ ];

const levelPrices = [5000,10000,20000,80000,160000,300000,500000,1000000,2000000,5000000];

let provider, signer, contract, account;

const connectBtn = document.getElementById("connectBtn");
const accountTxt = document.getElementById("account");
const bnbTxt = document.getElementById("bnbBalance");
const jryTxt = document.getElementById("jryBalance");
const referralsTxt = document.getElementById("referrals");
const levelsTxt = document.getElementById("levels");
const levelsPanel = document.getElementById("levelsPanel");

async function connectWallet() {
  if(window.ethereum){
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();
    accountTxt.textContent = "Ø§Ù„Ø­Ø³Ø§Ø¨: " + account;
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    loadUserData();
    renderLevels();
  } else {
    alert("âš ï¸ Ø®Ø§ØµÙƒ MetaMask");
  }
}

async function loadUserData(){
  try {
    // Ø±ØµÙŠØ¯ BNB
    const balance = await provider.getBalance(account);
    bnbTxt.textContent = "BNB: " + ethers.utils.formatEther(balance);

    // Ø±ØµÙŠØ¯ JRY
    const jryBalance = await contract.jerryToken().then(t => new ethers.Contract(t, [
      { "constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function" },
      { "constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
    ], signer));

    const decimals = await jryBalance.decimals();
    const balanceToken = await jryBalance.balanceOf(account);
    jryTxt.textContent = "JRY: " + balanceToken / (10**decimals);

    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const user = await contract.users(account);
    referralsTxt.textContent = "Direct Referrals: " + user.directReferrals;

    let levelsBought = [];
    for(let i=0;i<10;i++){
      if(user.levelsPurchased[i]) levelsBought.push(i+1);
    }
    levelsTxt.textContent = "Levels Purchased: " + levelsBought.join(", ");
  } catch(e){ console.error(e); }
}

function renderLevels(){
  levelsPanel.innerHTML = "";
  for(let i=0;i<10;i++){
    const div = document.createElement("div");
    div.style.margin = "10px 0";
    div.innerHTML = `
      <strong>Level ${i+1}</strong> - Price: ${levelPrices[i]} JRY
      <button onclick="buyLevel(${i})">Activate</button>
    `;
    levelsPanel.appendChild(div);
  }
}

async function buyLevel(level){
  try{
    let ref = prompt("ğŸ“Œ Ø¶Ø¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº:");
    if(ref == "") ref = ethers.constants.AddressZero;
    const tx = await contract.buyLevel(level, ref);
    await tx.wait();
    alert("âœ… Level " + (level+1) + " activated!");
    loadUserData();
  } catch(e){ console.error(e); alert("âŒ ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„"); }
}

connectBtn.addEventListener("click", connectWallet);
</script>
</body>
</html>
