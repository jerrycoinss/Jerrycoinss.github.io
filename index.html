<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Jerry Smart Matrix Dashboard</title>

<!-- Web3 -->
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<!-- Vis Network -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.css" rel="stylesheet" />

<style>
body { font-family: Arial; text-align: center; background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color: white; padding: 30px; }
h1 { margin-bottom: 20px; }
button { padding: 12px 25px; font-size: 1rem; border: none; border-radius: 10px; cursor: pointer; background: #00c6ff; color: black; margin:5px;}
button:hover { background:#0072ff; color:white;}
.info { margin: 15px; font-size:1.1rem;}
input { padding:6px; border-radius:6px; width:250px;}
#network { width: 100%; height: 500px; border: 1px solid #ccc; background: #fff; margin-top:20px; border-radius:10px;}
</style>
</head>
<body>

<h1>🚀 Jerry Smart Matrix</h1>

<button onclick="connectWallet()">🔗 Connect Wallet</button>
<p id="wallet-address"></p>

<div class="info">
  <p>Total Users: <span id="totalUsers">0</span></p>
  <p>Total Commissions: <span id="totalCommissions">0</span> JRY</p>
</div>

<div class="info">
  <p>Your Level: <span id="myLevel">0</span></p>
  <p>Your Earnings: <span id="myEarnings">0</span> JRY</p>
  <p>Direct Referrals: <span id="myDirects">0</span></p>
  <p>Team Size: <span id="myTeamSize">0</span></p>
</div>

<div class="info">
  <input type="number" id="level" placeholder="Level (0-9)" min="0" max="9"><br>
  <input type="text" id="referrer" placeholder="Referrer address"><br>
  <button onclick="buyLevel()">Buy Level</button>
</div>

<h2>Your Team Tree</h2>
<div id="network"></div>

<script>
const CONTRACT_ADDRESS = "0x33c847a9954f5FcB8a5cf32Bbbc3dDD56Bb80730";
const CONTRACT_ABI = [
  {
    "inputs":[{"internalType":"address","name":"_jerryToken","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],
    "stateMutability":"nonpayable","type":"constructor"
  },
  {"inputs":[],"name":"DIRECT_RATE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MAX_DIRECTS","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"TOTAL_LEVELS","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"TREASURY_RATE","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint8","name":"_level","type":"uint8"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"buyLevel","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"generationRates","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"jerryToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"levelPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"requiredDirects","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalCommissions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"directReferrals","type":"uint256"},{"internalType":"uint256","name":"totalEarned","type":"uint256"},{"internalType":"uint8","name":"maxLevel","type":"uint8"}],"stateMutability":"view","type":"function"}
];

let web3;
let contract;
let selectedAccount;
let networkInstance;

async function connectWallet(){
  if(window.ethereum){
    try{
      const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
      selectedAccount = accounts[0];
      document.getElementById("wallet-address").innerText = "✅ Connected: " + selectedAccount;
      web3 = new Web3(window.ethereum);
      contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
      updateStats();
      updateUserInfo();
      drawTeamTree();
    }catch(err){ alert("❌ Connection failed: "+err.message); }
  } else { alert("⚠️ Please install MetaMask!"); }
}

async function updateStats(){
  if(!contract) return;
  const totalUsers = await contract.methods.totalUsers().call();
  const totalCommissions = await contract.methods.totalCommissions().call();
  document.getElementById("totalUsers").innerText = totalUsers;
  document.getElementById("totalCommissions").innerText = web3.utils.fromWei(totalCommissions,'ether');
}

async function updateUserInfo(){
  if(!contract || !selectedAccount) return;
  const user = await contract.methods.users(selectedAccount).call();
  document.getElementById("myLevel").innerText = user.maxLevel;
  document.getElementById("myEarnings").innerText = web3.utils.fromWei(user.totalEarned,'ether');
  document.getElementById("myDirects").innerText = user.directReferrals;
  document.getElementById("myTeamSize").innerText = user.directReferrals; 
}

async function buyLevel(){
  if(!contract || !selectedAccount) return alert("Connect wallet first!");
  const level = parseInt(document.getElementById("level").value);
  const referrer = document.getElementById("referrer").value;
  try{
    await contract.methods.buyLevel(level, referrer).send({ from: selectedAccount });
    alert("✅ Level purchased!");
    updateStats();
    updateUserInfo();
    drawTeamTree();
  }catch(err){ alert("❌ Transaction failed: "+err.message); }
}

// --- Team Tree ---
async function drawTeamTree(){
  if(!contract || !selectedAccount) return;
  const nodes = [{id:selectedAccount,label:"You\nLvl:0",color:"#4CAF50"}];
  const edges = [];

  async function addTeamRecursive(addr, parent){
    try{
      const u = await contract.methods.users(addr).call();
      // هنا نقدر نضيف الـ direct referrals فقط لأنه الـ team array ما موجودش في ABI
      for(let i=0;i<u.directReferrals;i++){
        const childId = addr + "_"+i;
        nodes.push({id:childId,label:"Direct",color:"#87CEFA"});
        edges.push({from:parent,to:childId});
        // ما نقدرش ندخل deeper لغياب بيانات الفريق الحقيقية
      }
    }catch(err){ console.error(err); }
  }

  await addTeamRecursive(selectedAccount, selectedAccount);

  const container = document.getElementById("network");
  const data = {nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges)};
  const options = { nodes:{shape:"box"}, edges:{arrows:"to"}, layout:{hierarchical:{direction:"UD"}}, physics:{enabled:false} };
  
  if(!networkInstance){
    networkInstance = new vis.Network(container,data,options);
  } else {
    networkInstance.setData(data);
  }
}
</script>

</body>
</html>
